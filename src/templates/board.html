{% extends 'base.html' %}
{% block title %}Board · {{ season }} · CourtCraft{% endblock %}

{% block fullwidth %}
  <div class="bg-secondary-navy text-white py-4">
    <div class="container text-center">
      <h1 class="h3 mb-1">Draft Board — {{ season.replace('-', '/') }}</h1>
      <p class="mb-0 opacity-75">Mark taken players, tune league settings, and get player recommendations.</p>
    </div>
  </div>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Left: Taken Players -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Taken Players</span>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="btnPaste">Paste List</button>
          <button class="btn btn-sm btn-outline-danger" id="btnClear">Clear</button>
        </div>
      </div>
      <div class="card-body">
        <div id="jsError" class="alert alert-danger py-2 px-3 d-none" role="alert"></div>

        <form id="addTakenForm" class="row g-2" novalidate>
          <div class="col-8">
            <input
              type="text"
              class="form-control"
              id="takenInput"
              placeholder="Type a player name…"
              list="nameOptions"
              autocomplete="off">
            <datalist id="nameOptions"></datalist>
          </div>
          <div class="col-4 d-grid">
            <button class="btn btn-primary" id="btnAddTaken" type="button">Add</button>
          </div>
        </form>

        <div class="mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Total taken:</small>
            <span class="badge text-bg-secondary" id="takenCount">0</span>
          </div>
          <ul class="list-group mt-2" id="takenList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: My Team + Settings + Recommend + Results -->
  <div class="col-lg-6">
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>My Team (from Assemble Team)</span>
        {% if not logged_in_user %}
          <span class="badge bg-warning text-dark">Not logged in</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if team_players and team_players|length > 0 %}
          <ul class="list-group">
            {% for p in team_players %}
              <li class="list-group-item">{{ p }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="alert alert-info mb-2 d-flex justify-content-between align-items-center">
            <span>No saved team found for this season.</span>
            <a class="btn btn-sm btn-primary" href="{{ url_for('team_assemble_page', season=season) }}">Assemble Team</a>
          </div>
        {% endif %}

        <div class="mt-3">
          <label class="form-label">Scoring Type</label>
          <select class="form-select" id="scoringType">
            <option value="9cat" selected>9-category</option>
            <option value="8cat">8-category (TO ignored)</option>
          </select>
        </div>

        <div class="mt-3">
          <label class="form-label">Punt Categories (optional)</label>
          <div class="d-flex flex-wrap gap-2">
            {% set cats = ["PTS","REB","AST","STL","BLK","3PM","FG%","FT%","TO"] %}
            {% for c in cats %}
            <div class="form-check">
              <input class="form-check-input punt-cat" type="checkbox" value="{{ c }}" id="punt_{{ c }}">
              <label class="form-check-label" for="punt_{{ c }}">{{ c }}</label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Roster Constraints (optional)</label>
          <div class="row g-2">
            {% for pos in ["PG","SG","SF","PF","C","UTIL"] %}
            <div class="col-4">
              <div class="input-group input-group-sm">
                <span class="input-group-text">{{ pos }}</span>
                <input type="number" min="0" class="form-control roster-limit" data-pos="{{ pos }}" value="0">
              </div>
            </div>
            {% endfor %}
          </div>
          <small class="text-muted">Roster limits aren’t enforced in scoring yet — next step.</small>
        </div>

        <div class="mt-3 d-flex gap-2 flex-wrap">
          <button class="btn btn-success" id="btnRecommend" type="button">Recommend</button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Top Recommendations</div>
      <div class="card-body">
        <div id="recStatus" class="text-muted">Click “Recommend” to get suggestions.</div>
        <div class="table-responsive mt-2 d-none" id="recTableWrap">
          <table class="table table-sm align-middle mb-0" id="recTable">
            <thead>
              <tr>
                <th>Player</th>
                <th class="text-end">Score</th>
                <th>Top strengths</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal kept for compat; button uses prompt fallback too -->
<div class="modal fade" id="pasteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Paste player names (one per line)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="pasteArea" class="form-control" rows="10" placeholder="LeBron James
Nikola Jokic
Stephen Curry"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnPasteApply">Add to Taken</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const season = {{ season|tojson }};
  const teamPlayers = {{ (team_players or [])|tojson }};
  const defaultDataType = {{ (team_data_type or "nopunts")|tojson }};
  const storageKey = (suffix) => `board:${season}:${suffix}`;
  const el = (id) => document.getElementById(id);
  const showErr = (msg) => { const box = el('jsError'); if (!box) return; box.textContent = msg; box.classList.remove('d-none'); };
  const hideErr = () => { const box = el('jsError'); if (!box) return; box.classList.add('d-none'); };

  // ------- Valid names from Excel (canonical casing) -------
  let validNames = [];            // canonical names
  let nameMap = new Map();        // lower -> canonical
  let loadedNames = false;

  async function loadValidNames() {
    try {
      const res = await fetch(`/players/${season}`);
      const data = await res.json();
      validNames = (data.names || []);
      nameMap = new Map(validNames.map(n => [String(n).trim().toLowerCase(), String(n).trim()]));
      loadedNames = true;
    } catch (e) {
      loadedNames = false;
      showErr('Could not load player list for validation (you can still browse).');
      console.error(e);
    }
  }

  // ------- Taken state -------
  let taken = []; let takenKeys = new Set();
  function loadTaken(){ try{ taken = JSON.parse(localStorage.getItem(storageKey('taken'))) || [] }catch{ taken=[] } takenKeys=new Set(taken.map(s=>(s||'').trim().toLowerCase())); }
  function saveTaken(){ localStorage.setItem(storageKey('taken'), JSON.stringify(taken)); }
  function seedMyTeamOnce(){
    try{
      const seeded = JSON.parse(localStorage.getItem(storageKey('seededMyTeam'))) || false;
      if (seeded) return;
      for (const n of (teamPlayers||[])){
        const lower = (n||'').trim().toLowerCase();
        let canonical = nameMap.has(lower) ? nameMap.get(lower) : n;
        if(lower && !takenKeys.has(lower)){ taken.push(canonical); takenKeys.add(lower); }
      }
      saveTaken(); localStorage.setItem(storageKey('seededMyTeam'), 'true');
    }catch{}
  }

  function renderTaken(){
    const list=el('takenList'); const count=el('takenCount'); if(!list||!count) return;
    const map = new Map();
    for (const name of taken){ const k=(name||'').trim().toLowerCase(); if(k && !map.has(k)) map.set(k,name); }
    taken = Array.from(map.values()); takenKeys = new Set(taken.map(s=>(s||'').trim().toLowerCase()));
    list.innerHTML=''; const myTeamSet=new Set((teamPlayers||[]).map(n=>(n||'').trim().toLowerCase()));
    for (const name of taken){
      const isMine=myTeamSet.has((name||'').trim().toLowerCase());
      const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML=`<div class="d-flex align-items-center gap-2"><span>${name}</span>${isMine?"<span class='badge text-bg-info'>My Team</span>":""}</div>
        <button class="btn btn-sm btn-outline-danger" data-name="${name.replace(/"/g,'&quot;')}">&times;</button>`;
      list.appendChild(li);
    }
    count.textContent=String(taken.length);
  }

  function initTakenForm(){
    const form=el('addTakenForm'), input=el('takenInput'), addBtn=el('btnAddTaken'), list=el('takenList'), clearBtn=el('btnClear'), pasteBtn=el('btnPaste');
    if(!form||!input||!addBtn||!list||!clearBtn) return;
    const toKey=(s)=>(s||'').trim().toLowerCase();

    function validateAndCanonicalize(raw){
      const q = (raw||'').trim();
      if (!q) return { ok:false, msg:"Please type a player name." };
      if (!loadedNames) return { ok:false, msg:"Player list not loaded yet, try again in a moment." };
      const lower = q.toLowerCase();
      if (!nameMap.has(lower)) return { ok:false, msg:`“${q}” is not in the official player list for ${season}.` };
      return { ok:true, name:nameMap.get(lower), key:lower };
    }

    function addName(raw){
      hideErr();
      const check = validateAndCanonicalize(raw);
      if (!check.ok) { showErr(check.msg); return; }
      if (!takenKeys.has(check.key)) {
        taken.push(check.name);
        takenKeys.add(check.key);
        saveTaken(); renderTaken();
      }
    }

    form.addEventListener('submit',(e)=>{ e.preventDefault(); addName(input.value); input.value=''; input.focus(); });
    addBtn.addEventListener('click',()=>{ addName(input.value); input.value=''; input.focus(); });
    list.addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-name]'); if(!btn) return; const k=toKey(btn.getAttribute('data-name'));
      taken=taken.filter(n=>toKey(n)!==k); takenKeys.delete(k); saveTaken(); renderTaken(); });
    clearBtn.addEventListener('click',()=>{ if(!taken.length) return; if(!confirm('Clear all taken players?')) return; taken=[]; takenKeys.clear();
      for (const n of (teamPlayers||[])){ const low=toKey(n); let canon = nameMap.has(low) ? nameMap.get(low) : n;
        if(low && !takenKeys.has(low)){ taken.push(canon); takenKeys.add(low);} } saveTaken(); renderTaken(); });
    pasteBtn.addEventListener('click',()=>{ const lines=(prompt('Paste player names (one per line):','')||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      for(const n of lines) addName(n); });
  }

  function initAutocomplete(){
    const input=el('takenInput'), datalist=el('nameOptions'); if(!input||!datalist) return;
    const debounce=(fn,ms)=>{ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}; };
    const localSuggest=(term)=>{ const t=(term||'').toLowerCase(); const pool=validNames.length?validNames:[...(taken||[]), ...(teamPlayers||[])]; return Array.from(new Set(pool)).filter(n=>n && n.toLowerCase().includes(t)).slice(0,30); };
    const run=debounce(async ()=>{
      const term=(input.value||'').trim(); if(term.length<2){ datalist.innerHTML=''; return; }
      try{ const res=await fetch(`/autocomplete/${season}?term=${encodeURIComponent(term)}`); const s = res.ok ? await res.json() : localSuggest(term);
        datalist.innerHTML=(s||[]).slice(0,30).map(n=>`<option value="${n}"></option>`).join(''); }
      catch{ datalist.innerHTML=localSuggest(term).map(n=>`<option value="${n}"></option>`).join(''); }
    },150);
    input.addEventListener('input', run);
  }

  function initRecommend(){
    const btn=document.getElementById('btnRecommend'), recStatus=document.getElementById('recStatus'),
          wrap=document.getElementById('recTableWrap'), tbody=document.querySelector('#recTable tbody');
    if(!btn||!recStatus||!wrap||!tbody) return;
    const scoringSel=document.getElementById('scoringType'); const puntChecks=Array.from(document.querySelectorAll('.punt-cat')); const rosterInputs=Array.from(document.querySelectorAll('.roster-limit'));

    btn.addEventListener('click', async ()=>{
      const liveConfig={ scoringType: (scoringSel?scoringSel.value:'9cat'),
        punts: puntChecks.filter(ch=>ch.checked).map(ch=>ch.value),
        roster: Object.fromEntries(rosterInputs.map(inp=>[inp.dataset.pos, parseInt(inp.value||'0',10)||0])) };
      try{ localStorage.setItem(storageKey('config'), JSON.stringify(liveConfig)); }catch{}

      recStatus.classList.remove('text-danger'); recStatus.textContent='Calculating…'; wrap.classList.add('d-none'); tbody.innerHTML='';
      try{
        const res = await fetch(`/season/${season}/board/recommend`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ taken: taken, my_team: teamPlayers, data_type: defaultDataType,
                                 scoringType: liveConfig.scoringType, punts: liveConfig.punts, roster: liveConfig.roster })
        });
        const data = await res.json(); const recs = data.recommendations || [];
        if(!recs.length){ recStatus.classList.add('text-danger'); recStatus.textContent=data.error||'No candidates found.'; return; }
        const rows=[]; for (const r of recs){ const strengths=(r.top||[]).map(t=>`${t.stat} (+${t.v})`).join(', ');
          rows.push(`<tr><td>${r.Name}</td><td class="text-end">${r.score}</td><td>${strengths}</td></tr>`); }
        tbody.innerHTML=rows.join(''); wrap.classList.remove('d-none'); recStatus.textContent=`Top ${recs.length} suggestions`;
      }catch(e){ recStatus.classList.add('text-danger'); recStatus.textContent='Failed to compute recommendations.'; }
    });
  }

  // Boot in a safe order: load names first for canonicalization/validation
  (async () => {
    await loadValidNames();
    loadTaken();
    seedMyTeamOnce();
    renderTaken();

    try { initTakenForm(); } catch(e){ showErr('Add/remove UI failed to initialize.'); console.error(e); }
    try { initAutocomplete(); } catch(e){ showErr('Autocomplete failed to initialize.'); console.error(e); }
    try { initRecommend(); } catch(e){ showErr('Recommend failed to initialize.'); console.error(e); }
  })();
});
</script>
{% endblock %}
