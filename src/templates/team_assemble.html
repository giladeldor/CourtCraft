{% extends 'base.html' %}
{% block title %}Assemble Team · {{ season }} · CourtCraft{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" class="mt-3">
  <input type="hidden" name="data_type" value="{{ raw_type or 'nopunts' }}"/>

  <datalist id="allPlayers"></datalist>

  <div class="mb-3">
    <h5>Active Roster (13)</h5>
    <div class="row g-2">
      {% for i in range(1,14) %}
        {% set val = (registered_players[i-1] if registered_players and registered_players|length >= i else '') %}
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text">#{{ i }}</span>
            <input name="player{{ i }}" value="{{ val }}" class="form-control" list="allPlayers" autocomplete="off" placeholder="Player name">
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="mb-3">
    <h5>IR (does not count, max 2)</h5>
    <div class="row g-2">
      {% set ir1 = (ir_players[0] if ir_players and ir_players|length >= 1 else '') %}
      {% set ir2 = (ir_players[1] if ir_players and ir_players|length >= 2 else '') %}
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="input-group input-group-sm">
          <span class="input-group-text">IR #1</span>
          <input name="ir1" value="{{ ir1 }}" class="form-control" list="allPlayers" autocomplete="off" placeholder="Player name">
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="input-group input-group-sm">
          <span class="input-group-text">IR #2</span>
          <input name="ir2" value="{{ ir2 }}" class="form-control" list="allPlayers" autocomplete="off" placeholder="Player name">
        </div>
      </div>
    </div>
    <small class="text-muted">IR names must exist in the Excel. They’re excluded from totals.</small>
  </div>

  <div class="mb-3">
    <label class="form-label">Custom rankings Excel (optional)</label>
    <input type="file" name="custom_excel" class="form-control" accept=".xls,.xlsx">
  </div>

  <div class="mb-4">
    <button type="submit" class="btn btn-primary">Save & Calculate</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('board_page', season=season_url) }}">Open Board</a>
  </div>

  {% if analysis %}
    <div class="alert alert-info">Overall: <strong>{{ analysis }}</strong></div>
    {% if punt_buttons and punt_buttons|length > 0 %}
      <div class="mb-3 d-flex flex-wrap gap-2">
        {% for b in punt_buttons %}
          <span class="badge text-bg-light border">{{ b }}</span>
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}

  {% if results %}
    <div class="table-responsive mb-4">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            {% for k,v in results[0].items() %}
              {% if not k.endswith('_style') %}
                <th>{{ k }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in results %}
            <tr>
              {% for k,v in row.items() %}
                {% if not k.endswith('_style') %}
                  <td {{ row.get(k ~ '_style','')|safe }}>{{ v|safe }}</td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
          {% if totals %}
            <tr class="table-light">
              {% for k,v in totals.items() %}
                {% if not k.endswith('_style') %}
                  <td {{ totals.get(k ~ '_style','')|safe }}><strong>{{ v }}</strong></td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  {% endif %}

  {% if ir_rows and ir_rows|length > 0 %}
    <h6>IR Players (not counted):</h6>
    <div class="table-responsive mb-4">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            {% for k,v in ir_rows[0].items() %}
              {% if not k.endswith('_style') %}
                <th>{{ k }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in ir_rows %}
            <tr class="table-warning">
              {% for k,v in row.items() %}
                {% if not k.endswith('_style') %}
                  <td>{{ v|safe }}</td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
  // Fill the datalist with official names for this season (for browser autocomplete)
  const season = {{ season_url|tojson }};
  try {
    const res = await fetch(`/players/${season}`);
    const data = await res.json();
    const names = (data.names || []);
    const dl = document.getElementById('allPlayers');
    if (dl) dl.innerHTML = names.map(n => `<option value="${n}"></option>`).join('');
  } catch(e) {
    console.warn('Could not load player list for datalist.', e);
  }
});
</script>
{% endblock %}
