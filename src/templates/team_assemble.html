{% extends 'base.html' %}
{% block title %}Assemble Team â€“ NBA Fantasy{% endblock %}

{% block content %}
  <h1>Assemble Team: {{ season }}</h1>

  <form method="POST">
    <input type="hidden" name="data_type" id="data_type" value="{{ raw_type }}">
    {% for i in range(1,14) %}
      <input
        type="text"
        name="player{{ i }}"
        class="form-control player-input mb-2"
        placeholder="Player {{ i }}"
        value="{{ registered_players[i-1] if registered_players|length >= i else '' }}"
        autocomplete="off"
      >
    {% endfor %}
    <button type="submit" class="btn btn-primary mt-2">Submit Team</button>
  </form>

  <div class="mt-3">
    {% for btn in punt_buttons %}
      {% set key = btn.lower() %}
      <button
        type="button"
        class="btn punt-button {% if key == raw_type %}active{% endif %}"
        data-type="{{ key }}"
      >{{ btn }}</button>
    {% endfor %}
  </div>

  {% if results is not none %}
    {% if results %}
      <h3 class="mt-5">Your Team's Stats</h3>
      <h5>Analysis: {{ analysis }}</h5>

      {% if data_type == 'tovpunt' %}
        {% set cols=["Name","LeagV","puntV","pV","rV","aV","sV","bV","toV","fg%V","ft%V","3V"] %}
      {% else %}
        {% set cols=["Name","pV","rV","aV","sV","bV","toV","fg%V","ft%V","3V"] %}
      {% endif %}
      {% set color_cols=["pV","rV","aV","sV","bV","toV","fg%V","ft%V","3V"] %}

      <div class="table-responsive" style="max-height:350px; overflow:auto;">
        <table class="table table-striped table-sm">
          <thead><tr>
            {% for c in cols %}<th>{{ c }}</th>{% endfor %}
          </tr></thead>
          <tbody>
            {% for row in results %}
              <tr>
                {% for c in cols %}
                  {% if c in color_cols %}
                    <td {{ row[c ~ '_style']|safe }}>{{ row[c] }}</td>
                  {% else %}
                    <td>{{ row[c] }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
            {% if totals %}
              <tr class="totals">
                {% for c in cols %}
                  {% if c in color_cols %}
                    <td {{ totals[c ~ '_style']|safe }}>{{ totals[c] }}</td>
                  {% else %}
                    <td>{{ totals[c] }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-danger mt-4">
        No matching players found. Please check the names and try again.
      </p>
    {% endif %}
  {% endif %}

  <a href="{{ url_for('season_page', season=season_url) }}"
     class="btn btn-secondary mt-3">
    Back to Season Page
  </a>

  <!-- autocomplete & punt-button JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet"
        href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script>
    $(function(){
      $('.player-input').autocomplete({
        source(r,s){ $.getJSON(
          "{{ url_for('autocomplete',season=season_url) }}",
          {term:r.term}, s
        ); },
        minLength:2
      });
      $('.punt-button').click(function(){
        $('.punt-button').removeClass('active');
        $(this).addClass('active');
        $('#data_type').val($(this).data('type'));
      });
    });
  </script>
{% endblock %}
